import{e as v}from"./index.modern.d96712a8.js";import{n as g,l as f}from"./Swup.90c12983.js";function m(h){h=h||1;var e=[],t,r=[],n=0,l=0;function d(o,a){if(o.__t)if(a)t=e.indexOf(o),~t&&e.splice(t,1).length&&n--;else return;o.__t=1,(a?r:e).push(o),n++||i()}function s(){l--,i()}function i(){l<h&&n>0&&((r.shift()||e.shift())(),n--,l++)}return[d,s]}function p(){return p=Object.assign?Object.assign.bind():function(h){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(h[r]=t[r])}return h},p.apply(this,arguments)}const w=["preloadVisibleLinks"];class y extends v{constructor(e={}){var t;super(),t=this,this.name="SwupPreloadPlugin",this.requires={swup:">=4"},this.defaults={throttle:5,preloadInitialPage:!0,preloadHoveredLinks:!0,preloadVisibleLinks:{enabled:!1,threshold:.2,delay:500,containers:["body"]}},this.options=void 0,this.queue=void 0,this.preloadPromises=new Map,this.preloadObserver=void 0,this.mouseEnterDelegate=void 0,this.touchStartDelegate=void 0,this.focusDelegate=void 0,this.onPageLoad=(s,i,o)=>{const{url:a}=s.to;return this.preloadPromises.has(a)?this.preloadPromises.get(a):o?.(s,i)},this.onMouseEnter=async function(s){if(s.target!==s.delegateTarget||!t.deviceSupportsHover())return;const i=s.delegateTarget;i instanceof HTMLAnchorElement&&(t.swup.hooks.callSync("link:hover",{el:i,event:s}),t.preload(i,{priority:!0}))},this.onTouchStart=s=>{if(this.deviceSupportsHover())return;const i=s.delegateTarget;i instanceof HTMLAnchorElement&&this.preload(i,{priority:!0})},this.onFocus=s=>{const i=s.delegateTarget;i instanceof HTMLAnchorElement&&this.preload(i,{priority:!0})};const{preloadVisibleLinks:r}=e,n=function(s,i){if(s==null)return{};var o,a,u={},c=Object.keys(s);for(a=0;a<c.length;a++)i.indexOf(o=c[a])>=0||(u[o]=s[o]);return u}(e,w);this.options=p({},this.defaults,n),typeof r=="object"?this.options.preloadVisibleLinks=p({},this.options.preloadVisibleLinks,r):this.options.preloadVisibleLinks.enabled=!!r,this.preload=this.preload.bind(this);const[l,d]=m(this.options.throttle);this.queue={add:l,next:d}}mount(){const e=this.swup;e.options.cache?(e.hooks.create("page:preload"),e.hooks.create("link:hover"),e.preload=this.preload,e.preloadLinks=this.preloadLinks,this.mouseEnterDelegate=e.delegateEvent(e.options.linkSelector,"mouseenter",this.onMouseEnter,{passive:!0,capture:!0}),this.touchStartDelegate=e.delegateEvent(e.options.linkSelector,"touchstart",this.onTouchStart,{passive:!0,capture:!0}),this.focusDelegate=e.delegateEvent(e.options.linkSelector,"focus",this.onFocus,{passive:!0,capture:!0}),this.replace("page:load",this.onPageLoad),this.options.preloadHoveredLinks&&(this.preloadLinks(),this.on("page:view",()=>this.preloadLinks())),this.options.preloadVisibleLinks.enabled&&(this.preloadVisibleLinks(),this.on("page:view",()=>this.preloadVisibleLinks())),this.options.preloadInitialPage&&this.preload(g())):console.warn("SwupPreloadPlugin: swup cache needs to be enabled for preloading")}unmount(){var e,t,r;this.swup.preload=void 0,this.swup.preloadLinks=void 0,this.preloadPromises.clear(),(e=this.mouseEnterDelegate)==null||e.destroy(),(t=this.touchStartDelegate)==null||t.destroy(),(r=this.focusDelegate)==null||r.destroy(),this.stopPreloadingVisibleLinks()}deviceSupportsHover(){return window.matchMedia("(hover: hover)").matches}async preload(e,t={}){var r;let n,l;const d=(r=t.priority)!=null&&r;return Array.isArray(e)?Promise.all(e.map(s=>this.preload(s))):(e instanceof HTMLAnchorElement?(l=e,{url:n}=f.fromElement(e)):n=String(e),this.shouldPreload(n,l)?new Promise(s=>{this.queue.add(()=>{const i=this.performPreload(n);this.preloadPromises.set(n,i),i.catch(()=>{}).then(o=>s(o)).finally(()=>{this.queue.next(),this.preloadPromises.delete(n)})},d)}):void 0)}preloadLinks(){requestIdleCallback(()=>{Array.from(document.querySelectorAll("a[data-swup-preload], [data-swup-preload-all] a")).forEach(e=>this.preload(e))})}preloadVisibleLinks(){if(this.preloadObserver)return void this.preloadObserver.update();const{threshold:e,delay:t,containers:r}=this.options.preloadVisibleLinks,n=new Set,l=new IntersectionObserver(o=>{o.forEach(a=>{a.isIntersecting?d(a.target):s(a.target)})},{threshold:e}),d=o=>{n.add(o.href),setTimeout(()=>{n.has(o.href)&&(this.preload(o.href),l.unobserve(o))},t)},s=o=>n.delete(o.href),i=()=>{requestIdleCallback(()=>{const o=r.map(a=>`${a} a[href]`).join(", ");Array.from(document.querySelectorAll(o)).filter(a=>!this.triggerWillOpenNewWindow(a)).forEach(a=>l.observe(a))})};i(),this.preloadObserver={stop:()=>l.disconnect(),update:()=>(n.clear(),i())}}stopPreloadingVisibleLinks(){this.preloadObserver&&this.preloadObserver.stop()}shouldPreload(e,t){const{url:r,href:n}=f.fromUrl(e);return!(!this.networkSupportsPreloading()||this.swup.cache.has(r)||this.preloadPromises.has(r)||this.swup.shouldIgnoreVisit(n,{el:t})||t&&this.swup.resolveUrl(r)===this.swup.resolveUrl(g()))}networkSupportsPreloading(){if(navigator.connection){var e;if(navigator.connection.saveData||(e=navigator.connection.effectiveType)!=null&&e.endsWith("2g"))return!1}return!0}triggerWillOpenNewWindow(e){return e.matches('[download], [target="_blank"]')||e.origin!==window.location.origin}async performPreload(e){const t=await this.swup.fetchPage(e);return await this.swup.hooks.call("page:preload",{page:t}),t}}export{y as default};
